os:
  - linux
  - osx

language: nix

sudo: required

git:
  depth: 1

env:
  global:
    - ALL_TESTS=yes
    - secure: "dm6I+M4+V+C7QMTpcSADdKPE633SvmToXZrTbZ7miNDGmMN+/SfHeN2ybi1+PW6oViMlbPN/7J/aEfiGjSJI8vLk72Y4uCWGmpSb8TXZLu6+whnxtZzzW8+z4tsM4048QJg7CF3N/25U8thRFgs3DqUub1Sf3nG9LrNWdz6ZcDQ="

  matrix:
    - GHCVERSION=ghc802 STRICT=false TRACING=false
    - GHCVERSION=ghc802 STRICT=false TRACING=true
    - GHCVERSION=ghc822 STRICT=true  TRACING=false
    - GHCVERSION=ghc822 STRICT=true  TRACING=true
    - GHCVERSION=ghc843 STRICT=false TRACING=false
    - GHCVERSION=ghc843 STRICT=false TRACING=true
    - GHCVERSION=ghcjs

matrix:
  allow_failures:
    - env: GHCVERSION=ghcjs
  exclude:
    - env: GHCVERSION=ghc822 STRICT=false

before_script:
  - sudo mount -o remount,exec,size=4G,mode=755 /run/user || true
  - sudo mkdir -p /etc/nix
  - echo "trusted-users = root $USER" | sudo tee -a /etc/nix/nix.conf
  - sudo launchctl kickstart -k system/org.nixos.nix-daemon || true

script:
  - nix-env -if https://github.com/cachix/cachix/tarball/master --extra-substituters https://cachix.cachix.org --trusted-public-keys 'cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
    cachix.cachix.org-1:eWNHQldwUO7G2VkjpnjDbWwy4KQ/HNxht7H4SSoMckM='
  - cachix use hnix
  - cachix push hnix --watch-store &
  - bash build.sh | cachix push hnix

branches:
  only:
    - master
    - pending

notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/b0312b18473340459d3e
    on_success: change
    on_failure: always
    on_start: never
